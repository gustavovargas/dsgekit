name: core-linear-ci

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: core-linear-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  parser:
    name: parser
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      MAX_SECONDS: "180"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Run parser/core syntax tests
        shell: bash
        run: |
          start=$(date +%s)
          python -m pytest -q \
            tests/test_mod_parser.py \
            tests/test_nonlinear_expressions.py \
            --maxfail=1 --durations=10
          elapsed=$(( $(date +%s) - start ))
          echo "Parser elapsed: ${elapsed}s"
          echo "parser_elapsed_seconds=${elapsed}" >> "$GITHUB_STEP_SUMMARY"
          if [ "$elapsed" -gt "$MAX_SECONDS" ]; then
            echo "Parser job exceeded budget (${elapsed}s > ${MAX_SECONDS}s)" >&2
            exit 1
          fi

  solver:
    name: solver
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      MAX_SECONDS: "180"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Run solver/BK tests
        shell: bash
        run: |
          start=$(date +%s)
          python -m pytest -q \
            tests/test_ar1_pipeline.py \
            tests/test_diagnostics.py \
            tests/test_nk_model.py \
            tests/test_baseline_compat.py \
            tests/test_cli_baseline_regression.py \
            tests/test_osr.py \
            tests/test_cli_osr.py \
            tests/test_ramsey.py \
            tests/test_discretion.py \
            tests/test_third_order_pruning.py \
            --maxfail=1 --durations=10
          elapsed=$(( $(date +%s) - start ))
          echo "Solver elapsed: ${elapsed}s"
          echo "solver_elapsed_seconds=${elapsed}" >> "$GITHUB_STEP_SUMMARY"
          if [ "$elapsed" -gt "$MAX_SECONDS" ]; then
            echo "Solver job exceeded budget (${elapsed}s > ${MAX_SECONDS}s)" >&2
            exit 1
          fi

      - name: Baseline regression dashboard
        shell: bash
        run: |
          dsgekit baseline_regression \
            --baselines tests/fixtures/baselines \
            --dashboard baseline_regression_dashboard.md \
            --json-output baseline_regression_report.json
          {
            echo "### Baseline Regression Dashboard"
            echo ""
            cat baseline_regression_dashboard.md
          } >> "$GITHUB_STEP_SUMMARY"

  filters:
    name: filters
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      MAX_SECONDS: "300"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Run filter/estimation tests
        shell: bash
        run: |
          start=$(date +%s)
          python -m pytest -q \
            tests/test_kalman.py \
            tests/test_smoother.py \
            tests/test_mle.py \
            --maxfail=1 --durations=10
          elapsed=$(( $(date +%s) - start ))
          echo "Filters elapsed: ${elapsed}s"
          echo "filters_elapsed_seconds=${elapsed}" >> "$GITHUB_STEP_SUMMARY"
          if [ "$elapsed" -gt "$MAX_SECONDS" ]; then
            echo "Filters job exceeded budget (${elapsed}s > ${MAX_SECONDS}s)" >&2
            exit 1
          fi

  smoke-nk:
    name: smoke-nk
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      MAX_SECONDS: "120"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: NK smoke pipeline
        shell: bash
        run: |
          start=$(date +%s)
          python - <<'PY'
          from dsgekit import load_model
          from dsgekit.simulate import irf
          from dsgekit.solvers import diagnose_bk, solve_linear
          from dsgekit.transforms import linearize

          model_paths = [
              "tests/fixtures/models/nk.mod",
              "tests/fixtures/models/nk.yaml",
          ]

          for path in model_paths:
              model, cal, ss = load_model(path)
              solution = solve_linear(linearize(model, ss, cal))
              diag = diagnose_bk(solution)
              if diag.status != "determinate":
                  raise RuntimeError(f"{path}: expected determinate, got {diag.status}")
              for shock_name in model.shock_names:
                  result = irf(solution, shock_name, periods=8).data
                  if result.shape != (8, 3):
                      raise RuntimeError(
                          f"{path}: invalid IRF shape for {shock_name}: {result.shape}"
                      )
          print("NK smoke pipeline: OK")
          PY
          elapsed=$(( $(date +%s) - start ))
          echo "Smoke NK elapsed: ${elapsed}s"
          echo "smoke_nk_elapsed_seconds=${elapsed}" >> "$GITHUB_STEP_SUMMARY"
          if [ "$elapsed" -gt "$MAX_SECONDS" ]; then
            echo "Smoke NK job exceeded budget (${elapsed}s > ${MAX_SECONDS}s)" >&2
            exit 1
          fi
